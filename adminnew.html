<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="x-poe-datastore-behavior" content="local_only" />
    <!-- <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com;  connect-src 'self' http://localhost:8000; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;"
    /> -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel | 50 States Skydiving Challenge</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #0ea5e9;
        --primary-dark: #0284c7;
        --secondary: #8b5cf6;
        --accent: #f59e0b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --dark: #0f172a;
        --dark-light: #1e293b;
        --gray: #64748b;
        --gray-light: #94a3b8;
        --gray-lighter: #e2e8f0;
        --white: #ffffff;
        --bg-primary: #f8fafc;
        --gradient-primary: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
        --gradient-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-primary);
        color: var(--dark);
        min-height: 100vh;
      }

      /* Login Screen */
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-dark);
        position: relative;
        overflow: hidden;
      }

      .login-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      }

      .login-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 1.5rem;
        padding: 3rem;
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 400px;
        width: 100%;
        margin: 2rem;
        position: relative;
        z-index: 2;
        animation: slideInUp 0.6s ease-out;
      }

      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .login-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .login-subtitle {
        color: var(--gray);
        font-size: 0.875rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--dark);
      }

      .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-lighter);
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: var(--white);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
      }

      .form-input.error {
        border-color: var(--danger);
        animation: shake 0.4s ease-in-out;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      .btn {
        background: var(--gradient-primary);
        color: var(--white);
        border: none;
        padding: 0.875rem 2rem;
        border-radius: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.6s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.loading {
        opacity: 0.8;
        cursor: not-allowed;
      }

      /* Admin Dashboard */
      .admin-dashboard {
        display: none;
        min-height: 100vh;
      }

      .admin-header {
        background: var(--gradient-dark);
        color: var(--white);
        padding: 1.5rem 0;
        box-shadow: var(--shadow-md);
      }

      .admin-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      .admin-logo {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--white);
      }

      .admin-user {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .admin-user-info {
        text-align: right;
      }

      .admin-user-name {
        font-weight: 600;
        font-size: 0.875rem;
      }

      .admin-user-role {
        font-size: 0.75rem;
        opacity: 0.8;
      }

      .logout-btn {
        background: rgba(239, 68, 68, 0.2);
        color: var(--white);
        border: 1px solid rgba(239, 68, 68, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .logout-btn:hover {
        background: var(--danger);
        border-color: var(--danger);
      }

      .admin-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        display: grid;
        gap: 2rem;
      }

      /* Dashboard Cards */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .dashboard-card {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-lighter);
        transition: all 0.3s ease;
      }

      .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card-icon {
        font-size: 1.5rem;
        opacity: 0.7;
      }

      .card-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .card-subtitle {
        font-size: 0.875rem;
        color: var(--gray);
      }

      /* Current Location Control */
      .location-control {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .location-control h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .location-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .location-toggle {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
        background: var(--gray-lighter);
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .toggle-switch.active {
        background: var(--success);
      }

      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: var(--white);
        border-radius: 50%;
        transition: transform 0.3s ease;
      }

      .toggle-switch.active .toggle-slider {
        transform: translateX(26px);
      }

      /* Timer Control */
      .timer-control {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        text-align: center;
        margin-bottom: 2rem;
      }

      .timer-display {
        font-family: "Inter", monospace;
        font-size: clamp(2rem, 6vw, 4rem);
        font-weight: 900;
        color: var(--primary);
        margin: 1.5rem 0;
        padding: 1.5rem;
        background: var(--bg-primary);
        border-radius: 1rem;
        border: 2px solid var(--gray-lighter);
      }

      .timer-display.running {
        color: var(--success);
        border-color: var(--success);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .timer-labels {
        display: flex;
        justify-content: space-around;
        margin-bottom: 2rem;
        font-size: 0.875rem;
        color: var(--gray);
        font-weight: 500;
      }

      .timer-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn-success {
        background: var(--success);
      }
      .btn-danger {
        background: var(--danger);
      }
      .btn-warning {
        background: var(--warning);
      }

      .btn-success:hover {
        background: #0d9488;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .btn-warning:hover {
        background: #d97706;
      }

      /* Milestone Form */
      .milestone-form {
        background: var(--white);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
      }

      .form-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--gray-lighter);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.2s ease;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
      }

      .form-textarea {
        resize: vertical;
        min-height: 100px;
      }

      /* File Upload */
      .file-upload {
        border: 2px dashed var(--gray-lighter);
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-primary);
      }

      .file-upload:hover {
        border-color: var(--primary);
        background: rgba(14, 165, 233, 0.05);
      }

      .file-upload.has-file {
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.05);
      }

      .file-upload-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        opacity: 0.6;
      }

      .file-upload-text {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .file-upload-hint {
        font-size: 0.875rem;
        color: var(--gray);
      }

      /* Video Management */
      .video-management {
        margin-top: 1rem;
      }

      .uploaded-videos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .uploaded-video-item {
        background: var(--bg-primary);
        border: 1px solid var(--gray-lighter);
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .video-thumbnail {
        width: 60px;
        height: 40px;
        background: var(--gradient-primary);
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 1.2rem;
      }

      .video-details {
        flex: 1;
      }

      .video-name {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--dark);
        margin-bottom: 0.25rem;
      }

      .video-size {
        font-size: 0.75rem;
        color: var(--gray);
      }

      .video-remove {
        background: var(--danger);
        color: var(--white);
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.2s ease;
      }

      .video-remove:hover {
        background: #dc2626;
      }

      /* States Overview */
      .states-overview {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
      }

      .states-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .states-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
      }

      .state-item {
        padding: 1rem;
        border: 1px solid var(--gray-lighter);
        border-radius: 0.5rem;
        text-align: center;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
      }

      .state-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
      }

      .state-item.completed {
        background: rgba(16, 185, 129, 0.1);
        border-color: var(--success);
        color: var(--success);
      }

      .state-item.current-location {
        background: rgba(245, 158, 11, 0.1);
        border-color: var(--warning);
        color: var(--warning);
        animation: currentStatePulse 2s ease-in-out infinite;
      }

      .state-item.current-location::after {
        content: "🔴";
        position: absolute;
        top: -5px;
        right: -5px;
        animation: blink 1s ease-in-out infinite;
      }

      @keyframes currentStatePulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--white);
        border-radius: 1rem;
        width: 95%;
        max-width: 900px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        transform: scale(0.9) translateY(50px);
        transition: all 0.3s ease;
        box-shadow: var(--shadow-xl);
      }

      .modal-overlay.active .modal {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--gray-lighter);
        position: sticky;
        top: 0;
        background: var(--white);
        z-index: 10;
      }

      .modal-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--dark);
        margin-bottom: 0.5rem;
      }

      .modal-subtitle {
        color: var(--gray);
        font-size: 1rem;
      }

      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: var(--gray);
        transition: color 0.2s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }

      .modal-close:hover {
        color: var(--danger);
        background: var(--gray-lighter);
      }

      .modal-content {
        padding: 2rem;
      }

      .modal-section {
        margin-bottom: 2rem;
      }

      .modal-section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 1.5rem 2rem;
        border-top: 1px solid var(--gray-lighter);
        background: var(--bg-primary);
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-outline:hover {
        background: var(--primary);
        color: var(--white);
      }

      .btn-outline.danger {
        border-color: var(--danger);
        color: var(--danger);
      }

      .btn-outline.danger:hover {
        background: var(--danger);
        color: var(--white);
      }

      /* State Edit Form */
      .state-edit-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .state-videos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
      }

      .state-video-item {
        background: var(--bg-primary);
        border: 1px solid var(--gray-lighter);
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease;
      }

      .state-video-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .video-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
      }

      .video-item-thumbnail {
        width: 80px;
        height: 60px;
        background: var(--gradient-primary);
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .video-item-info {
        flex: 1;
      }

      .video-item-title {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.25rem;
      }

      .video-item-meta {
        font-size: 0.875rem;
        color: var(--gray);
      }

      .video-item-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .btn-small {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
      }

      /* Data Management */
      .data-management {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .data-section {
        background: var(--white);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
      }

      .data-section h3 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--dark);
      }

      .data-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .data-stat {
        text-align: center;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 0.5rem;
      }

      .data-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
      }

      .data-stat-label {
        font-size: 0.875rem;
        color: var(--gray);
      }

      /* Success Notification */
      .notification {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: var(--success);
        color: var(--white);
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: var(--shadow-xl);
        z-index: 1000;
        animation: slideInRight 0.3s ease-out,
          slideOutRight 0.3s ease-in 2.7s forwards;
        max-width: 400px;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOutRight {
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .admin-nav {
          padding: 0 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .admin-content {
          padding: 1rem;
        }

        .form-grid,
        .state-edit-form {
          grid-template-columns: 1fr;
        }

        .timer-controls {
          flex-direction: column;
          align-items: center;
        }

        .data-management {
          grid-template-columns: 1fr;
        }

        .location-form {
          grid-template-columns: 1fr;
        }

        .modal-actions {
          flex-direction: column;
        }

        .state-videos-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script>
  </head>
  <body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
      <div class="login-card">
        <div class="login-header">
          <h1 class="login-title">🪂 Admin Portal</h1>
          <p class="login-subtitle">
            50 States Skydiving Challenge Control Center
          </p>
        </div>

        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label" for="adminPassword"
              >Administrator Password</label
            >
            <input
              type="password"
              id="adminPassword"
              class="form-input"
              placeholder="Enter secure password"
              required=""
            />
          </div>

          <button type="submit" class="btn" id="loginBtn">
            Access Control Panel
          </button>
        </form>

        <div style="text-align: center; margin-top: 1.5rem">
          <a
            href="index.html"
            style="
              color: var(--gray);
              text-decoration: none;
              font-size: 0.875rem;
            "
          >
            ← Back to Public View
          </a>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
      <!-- Header -->
      <header class="admin-header">
        <nav class="admin-nav">
          <div class="admin-logo">🪂 SkyRecord Admin</div>
          <div class="admin-user">
            <div class="admin-user-info">
              <div class="admin-user-name">Administrator</div>
              <div class="admin-user-role">Challenge Controller</div>
            </div>
            <button class="logout-btn" onclick="adminLogout()">Logout</button>
          </div>
        </nav>
      </header>

      <!-- Main Content -->
      <main class="admin-content">
        <!-- Dashboard Overview -->
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">States Completed</div>
              <div class="card-icon">🏁</div>
            </div>
            <div class="card-value" id="dashCompletedStates">0</div>
            <div class="card-subtitle">of 50 total states</div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Total Time</div>
              <div class="card-icon">⏱️</div>
            </div>
            <div class="card-value" id="dashTotalTime">00:00:00</div>
            <div class="card-subtitle">challenge duration</div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Videos Uploaded</div>
              <div class="card-icon">🎬</div>
            </div>
            <div class="card-value" id="dashVideoCount">0</div>
            <div class="card-subtitle">video evidence files</div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Challenge Status</div>
              <div class="card-icon">🎯</div>
            </div>
            <div class="card-value" id="dashStatus">Not Started</div>
            <div class="card-subtitle">current state</div>
          </div>

          <div class="dashboard-card">
            <div class="card-header">
              <div class="card-title">Best Day</div>
              <div class="card-icon">🚀</div>
            </div>
            <div class="card-value" id="dashBestDay">0</div>
            <div class="card-subtitle">states in one day</div>
          </div>
        </div>

        <!-- Current Location Control -->
        <section class="location-control">
          <h2>📍 Current Location Management</h2>

          <div class="location-toggle">
            <div
              class="toggle-switch"
              id="locationToggle"
              onclick="toggleLocationTracking()"
            >
              <div class="toggle-slider"></div>
            </div>
            <span>Enable Live Location Tracking</span>
          </div>

          <div class="location-form" id="locationForm" style="display: none">
            <div class="form-group">
              <label class="form-label" for="currentState">Current State</label>
              <select id="currentState" class="form-select">
                <option value="">Select current state...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="currentCity">Current City</label>
              <input
                type="text"
                id="currentCity"
                class="form-input"
                placeholder="e.g., Los Angeles"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="currentStatus">Status</label>
              <select id="currentStatus" class="form-select">
                <option value="Preparing for jump">Preparing for jump</option>
                <option value="Equipment check in progress">
                  Equipment check in progress
                </option>
                <option value="Weather assessment">Weather assessment</option>
                <option value="Final preparations">Final preparations</option>
                <option value="Ready for takeoff">Ready for takeoff</option>
                <option value="In transit">In transit</option>
                <option value="On standby">On standby</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="dropZone">Drop Zone</label>
              <input
                type="text"
                id="dropZone"
                class="form-input"
                placeholder="e.g., California Skydiving Center"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="weatherCondition"
                >Weather Condition</label
              >
              <select id="weatherCondition" class="form-select">
                <option value="Clear skies">Clear skies</option>
                <option value="Partly cloudy">Partly cloudy</option>
                <option value="Mostly sunny">Mostly sunny</option>
                <option value="Overcast">Overcast</option>
                <option value="Light winds">Light winds</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="temperature"
                >Temperature (°F)</label
              >
              <input
                type="number"
                id="temperature"
                class="form-input"
                placeholder="e.g., 72"
                min="0"
                max="120"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="windSpeed">Wind Speed (mph)</label>
              <input
                type="number"
                id="windSpeed"
                class="form-input"
                placeholder="e.g., 8"
                min="0"
                max="50"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="estimatedJumpTime"
                >Estimated Jump Time</label
              >
              <input
                type="datetime-local"
                id="estimatedJumpTime"
                class="form-input"
              />
            </div>
          </div>

          <div style="text-align: center">
            <button
              class="btn btn-primary"
              onclick="updateCurrentLocation()"
              id="updateLocationBtn"
              style="display: none"
            >
              📍 Update Location
            </button>
          </div>
        </section>

        <!-- Timer Control -->
        <section class="timer-control">
          <h2>⏱️ Challenge Timer Control</h2>
          <div class="timer-labels">
            <span>Days</span>
            <span>Hours</span>
            <span>Minutes</span>
            <span>Seconds</span>
          </div>
          <div class="timer-display" id="adminTimerDisplay">00:00:00:00</div>
          <div class="timer-controls">
            <button
              class="btn btn-success"
              onclick="startChallenge()"
              id="startChallengeBtn"
            >
              🚀 Start Challenge
            </button>
            <button
              class="btn btn-danger"
              onclick="pauseChallenge()"
              id="pauseChallengeBtn"
              disabled=""
            >
              ⏸️ Pause Challenge
            </button>
            <button class="btn btn-warning" onclick="resetChallenge()">
              🔄 Reset Challenge
            </button>
          </div>
        </section>

        <!-- Milestone Entry Form -->
        <section class="milestone-form" id="milestoneFormSection">
          <h2 class="form-title">🎯 Log New Milestone</h2>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="stateSelect">State</label>
              <select
                id="stateSelect"
                class="form-select"
                onchange="validateStateSelection()"
              >
                <option value="">Select state...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="jumpDateTime"
                >Jump Date &amp; Time</label
              >
              <input
                type="datetime-local"
                id="jumpDateTime"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="altitude">Altitude (feet)</label>
              <input
                type="number"
                id="altitude"
                class="form-input"
                placeholder="e.g., 15000"
                min="1000"
                max="50000"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="location"
                >Drop Zone Location</label
              >
              <input
                type="text"
                id="location"
                class="form-input"
                placeholder="e.g., Skydive Arizona, Eloy"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="duration"
                >Jump Duration (seconds)</label
              >
              <input
                type="number"
                id="duration"
                class="form-input"
                placeholder="e.g., 60"
                min="10"
                max="600"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="weather">Weather Conditions</label>
              <input
                type="text"
                id="weather"
                class="form-input"
                placeholder="e.g., Clear skies, 10mph winds"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="notes"
              >Jump Notes &amp; Details</label
            >
            <textarea
              id="notes"
              class="form-textarea"
              placeholder="Detailed description of the jump, conditions, any notable events..."
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Video Evidence Upload</label>
            <div
              class="file-upload"
              id="fileUpload"
              onclick="triggerFileInput()"
            >
              <div class="file-upload-icon">📹</div>
              <div class="file-upload-text">Click to select video files</div>
              <div class="file-upload-hint">
                Supported: MP4, MOV, AVI (Max 500MB each)
              </div>
              <input
                type="file"
                id="videoFile"
                accept="video/*"
                multiple=""
                style="display: none"
                onchange="handleFileSelection(this)"
              />
            </div>

            <div class="video-management">
              <div id="uploadedVideos" class="uploaded-videos">
                <!-- Uploaded videos will appear here -->
              </div>
            </div>
          </div>

          <div style="text-align: center">
            <button
              class="btn btn-success"
              onclick="saveMilestone()"
              style="padding: 1rem 3rem; font-size: 1.1rem"
            >
              ✅ Record Milestone
            </button>
          </div>
        </section>

        <!-- Data Management -->
        <div class="data-management">
          <div class="data-section">
            <h3>📊 Data Management</h3>
            <div class="data-stats">
              <div class="data-stat">
                <div class="data-stat-value" id="totalMilestones">0</div>
                <div class="data-stat-label">Milestones</div>
              </div>
              <div class="data-stat">
                <div class="data-stat-value" id="dataSize">0 KB</div>
                <div class="data-stat-label">Data Size</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-direction: column">
              <button class="btn btn-outline" onclick="exportData()">
                📤 Export Data
              </button>
              <button class="btn btn-outline" onclick="importData()">
                📥 Import Data
              </button>
              <button class="btn btn-outline danger" onclick="clearAllData()">
                🗑️ Clear All Data
              </button>
            </div>
            <input
              type="file"
              id="importFile"
              accept=".json"
              style="display: none"
              onchange="handleDataImport(this)"
            />
          </div>

          <div class="data-section">
            <h3>🔄 System Status</h3>
            <div class="data-stats">
              <div class="data-stat">
                <div class="data-stat-value" id="lastUpdate">--</div>
                <div class="data-stat-label">Last Update</div>
              </div>
              <div class="data-stat">
                <div class="data-stat-value" id="systemStatus">🟢</div>
                <div class="data-stat-label">System</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-direction: column">
              <button class="btn btn-outline" onclick="backupData()">
                💾 Backup Data
              </button>
              <button class="btn btn-outline" onclick="refreshData()">
                🔄 Refresh Data
              </button>
            </div>
          </div>
        </div>

        <!-- States Overview -->
        <section class="states-overview">
          <div class="states-header">
            <h3>🗺️ States Management</h3>
            <div style="font-size: 0.875rem; color: var(--gray)">
              <span id="statesCompleted">0</span> of 50 completed • Click states
              to manage
            </div>
          </div>
          <div class="states-grid" id="adminStatesGrid">
            <!-- States will be populated by JavaScript -->
          </div>
        </section>
      </main>
    </div>

    <!-- State Management Modal -->
    <div class="modal-overlay" id="stateModal">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title" id="stateModalTitle">State Management</h2>
          <p class="modal-subtitle" id="stateModalSubtitle">
            Edit state information and manage videos
          </p>
          <button class="modal-close" onclick="closeStateModal()">×</button>
        </div>
        <div class="modal-content" id="stateModalContent">
          <!-- Content will be populated by JavaScript -->
        </div>
        <div class="modal-actions" id="stateModalActions">
          <!-- Actions will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // US States Array
      const STATES = [
        "Alabama",
        "Alaska",
        "Arizona",
        "Arkansas",
        "California",
        "Colorado",
        "Connecticut",
        "Delaware",
        "Florida",
        "Georgia",
        "Hawaii",
        "Idaho",
        "Illinois",
        "Indiana",
        "Iowa",
        "Kansas",
        "Kentucky",
        "Louisiana",
        "Maine",
        "Maryland",
        "Massachusetts",
        "Michigan",
        "Minnesota",
        "Mississippi",
        "Missouri",
        "Montana",
        "Nebraska",
        "Nevada",
        "New Hampshire",
        "New Jersey",
        "New Mexico",
        "New York",
        "North Carolina",
        "North Dakota",
        "Ohio",
        "Oklahoma",
        "Oregon",
        "Pennsylvania",
        "Rhode Island",
        "South Carolina",
        "South Dakota",
        "Tennessee",
        "Texas",
        "Utah",
        "Vermont",
        "Virginia",
        "Washington",
        "West Virginia",
        "Wisconsin",
        "Wyoming",
      ];
      const API_BASE_URL =
        "https://sky-diving-backend-production.up.railway.app";

      // Challenge data structure
      let challengeData = {
        isActive: false,
        startTime: null,
        pausedTime: null,
        totalPausedDuration: 0,
        completedStates: [],
        milestones: [],
        lastUpdate: new Date().toISOString(),
        currentLocation: null,
        locationTrackingEnabled: false,
      };

      let timerInterval = null;
      let uploadedVideoFiles = [];
      let currentEditingState = null;

      // Initialize admin panel
      function initializeAdmin() {
        populateStateSelectors();
        loadChallengeData();
        updateAllDisplays();
        startRealTimeUpdates();

        // Set current datetime
        document.getElementById("jumpDateTime").value = getCurrentDateTime();

        console.log("🛡️ Admin panel initialized");
      }

      function getCurrentDateTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
      }

      // Authentication
      async function handleLogin(event) {
        event.preventDefault();

        const password = document.getElementById("adminPassword").value;
        const loginBtn = document.getElementById("loginBtn");
        const passwordInput = document.getElementById("adminPassword");

        loginBtn.classList.add("loading");
        loginBtn.textContent = "Authenticating...";

        try {
          // Wait for 1 second before making the request (optional delay)
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const res = await fetch(`${API_BASE_URL}/admin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: password }), // or credentialResponse.credential if you have it
          });

          const data = await res.json();
          console.log(data);

          if (res.ok && data.success === true) {
            document.getElementById("loginContainer").style.display = "none";
            document.getElementById("adminDashboard").style.display = "block";

            initializeAdmin();
            showNotification("🔓 Administrator access granted", "success");
          } else {
            passwordInput.classList.add("error");
            showNotification("❌ Invalid password", "error");

            setTimeout(() => {
              passwordInput.classList.remove("error");
              passwordInput.value = "";
            }, 1000);
          }
        } catch (error) {
          console.error("Login failed:", error);
          showNotification("⚠️ Cannot connect to server", "error");
        }

        loginBtn.classList.remove("loading");
        loginBtn.textContent = "Access Control Panel";
      }
      // State Management Modal Functions
      function openStateModal(state) {
        currentEditingState = state;
        const modal = document.getElementById("stateModal");
        const modalTitle = document.getElementById("stateModalTitle");
        const modalSubtitle = document.getElementById("stateModalSubtitle");
        const modalContent = document.getElementById("stateModalContent");
        const modalActions = document.getElementById("stateModalActions");

        const milestone = challengeData.milestones.find(
          (m) => m.state === state
        );
        const isCompleted = challengeData.completedStates.includes(state);
        const isCurrent = challengeData.currentLocation?.state === state;

        modalTitle.textContent = `${state} Management`;

        if (isCompleted && milestone) {
          modalSubtitle.textContent =
            "Edit completed state information and manage videos";
          modalContent.innerHTML = generateEditStateContent(milestone);
          modalActions.innerHTML = generateCompletedStateActions(state);
        } else if (isCurrent) {
          modalSubtitle.textContent =
            "Currently active location - Quick jump recording";
          modalContent.innerHTML = generateCurrentStateContent(state);
          modalActions.innerHTML = generateCurrentStateActions(state);
        } else {
          modalSubtitle.textContent =
            "Pending state - Add milestone when ready";
          modalContent.innerHTML = generatePendingStateContent(state);
          modalActions.innerHTML = generatePendingStateActions(state);
        }

        modal.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeStateModal() {
        const modal = document.getElementById("stateModal");
        modal.classList.remove("active");
        document.body.style.overflow = "auto";
        currentEditingState = null;
      }

      function generateEditStateContent(milestone) {
        return `
                <div class="modal-section">
                    <h3 class="modal-section-title">✏️ Edit State Information</h3>
                    <div class="state-edit-form">
                        <div class="form-group">
                            <label class="form-label">Jump Date & Time</label>
                            <input type="datetime-local" id="editJumpDateTime" class="form-input" value="${new Date(
                              milestone.jumpTime
                            )
                              .toISOString()
                              .slice(0, 16)}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Altitude (feet)</label>
                            <input type="number" id="editAltitude" class="form-input" value="${
                              milestone.altitude || ""
                            }" min="1000" max="50000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Drop Zone Location</label>
                            <input type="text" id="editLocation" class="form-input" value="${
                              milestone.location || ""
                            }">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Jump Duration (seconds)</label>
                            <input type="number" id="editDuration" class="form-input" value="${
                              milestone.duration || ""
                            }" min="10" max="600">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Weather Conditions</label>
                            <input type="text" id="editWeather" class="form-input" value="${
                              milestone.weather || ""
                            }">
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Jump Notes & Details</label>
                            <textarea id="editNotes" class="form-textarea">${
                              milestone.notes || ""
                            }</textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title">🎬 Video Management</h3>
                    <div class="state-videos-grid" id="stateVideosGrid">
                        ${generateVideoManagementGrid(milestone)}
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <div class="file-upload" onclick="triggerStateVideoInput()">
                            <div class="file-upload-icon">📹</div>
                            <div class="file-upload-text">Add More Videos</div>
                            <div class="file-upload-hint">Supported: MP4, MOV, AVI (Max 500MB each)</div>
                            <input type="file" id="stateVideoFile" accept="video/*" multiple style="display: none;" onchange="handleStateVideoSelection(this)">
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3 class="modal-section-title">📊 Milestone Information</h3>
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 0.5rem; font-size: 0.875rem; color: var(--gray);">
                        <p><strong>Completion Order:</strong> #${
                          milestone.completionOrder
                        } of 50</p>
                        <p><strong>Recorded:</strong> ${formatDateTime(
                          new Date(milestone.recordedAt)
                        )}</p>
                        <p><strong>Milestone ID:</strong> ${milestone.id}</p>
                        <p><strong>Videos:</strong> ${
                          milestone.videos?.length || 0
                        } files</p>
                    </div>
                </div>
            `;
      }

      function generateVideoManagementGrid(milestone) {
        const videos = milestone.videos || [];

        if (videos.length === 0) {
          return `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">📹</div>
                        <p>No videos uploaded for this jump yet</p>
                    </div>
                `;
        }

        return videos
          .map(
            (video, index) => `
                <div class="state-video-item">
                    <div class="video-item-thumbnail">🎬</div>
                    <div class="video-item-info">
                        <div class="video-item-title">${
                          video.originalName || video.fileName
                        }</div>
                        <div class="video-item-meta">
                            ${formatFileSize(video.size)} • ${formatDate(
              new Date(video.uploadedAt)
            )}
                        </div>
                    </div>
                    <div class="video-item-actions">
                        <button class="btn btn-outline btn-small" onclick="playStateVideo('${
                          video.fileName
                        }')">
                            ▶ Play
                        </button>
                        <button class="btn btn-outline danger btn-small" onclick="removeStateVideo(${index})">
                            🗑️ Remove
                        </button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function generateCurrentStateContent(state) {
        return `
                <div class="modal-section">
                    <h3 class="modal-section-title">🔴 Current Location Quick Recording</h3>
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 2rem; border-radius: 1rem; border-left: 4px solid var(--warning); margin-bottom: 2rem;">
                        <p style="color: var(--dark); font-weight: 600; margin-bottom: 1rem;">
                            🎯 You're currently in ${state}! Ready to record a jump?
                        </p>
                        <p style="color: var(--gray); font-size: 0.875rem;">
                            This will use the current location data and allow you to quickly record the completed jump.
                        </p>
                    </div>

                    <div class="state-edit-form">
                        <div class="form-group">
                            <label class="form-label">Jump Date & Time</label>
                            <input type="datetime-local" id="quickJumpDateTime" class="form-input" value="${getCurrentDateTime()}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Altitude (feet)</label>
                            <input type="number" id="quickAltitude" class="form-input" placeholder="e.g., 15000" min="1000" max="50000">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Drop Zone Location</label>
                            <input type="text" id="quickLocation" class="form-input" value="${
                              challengeData.currentLocation?.dropZone || ""
                            }" placeholder="Drop zone name">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Jump Duration (seconds)</label>
                            <input type="number" id="quickDuration" class="form-input" placeholder="e.g., 60" min="10" max="600">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Weather Conditions</label>
                            <input type="text" id="quickWeather" class="form-input" value="${
                              challengeData.currentLocation?.weather
                                ? `${challengeData.currentLocation.weather.condition}, ${challengeData.currentLocation.weather.temperature}°F, ${challengeData.currentLocation.weather.windSpeed}mph winds`
                                : ""
                            }" placeholder="Weather conditions">
                        </div>

                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Jump Notes & Details</label>
                            <textarea id="quickNotes" class="form-textarea" placeholder="Describe the jump experience..."></textarea>
                        </div>
                    </div>
                </div>
            `;
      }

      function generatePendingStateContent(state) {
        return `
                <div class="modal-section">
                    <h3 class="modal-section-title">📍 Pending State</h3>
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">🪂</div>
                        <h4 style="color: var(--dark); margin-bottom: 1rem;">${state} - Not Yet Completed</h4>
                        <p style="margin-bottom: 2rem;">
                            This state is pending completion in the 50-state skydiving challenge.
                            Use the main milestone form below or set this as your current location to begin tracking.
                        </p>

                        <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 0.5rem; border-left: 4px solid var(--primary); margin-bottom: 1.5rem;">
                            <h5 style="color: var(--dark); margin-bottom: 0.5rem;">Available Actions:</h5>
                            <ul style="text-align: left; color: var(--gray); padding-left: 1rem; list-style: none;">
                                <li style="margin-bottom: 0.5rem;">📍 Set as current location for live tracking</li>
                                <li style="margin-bottom: 0.5rem;">🎯 Record jump using main milestone form</li>
                                <li style="margin-bottom: 0.5rem;">📋 Pre-fill main form with this state</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
      }

      function generateCompletedStateActions(state) {
        return `
                <button class="btn btn-outline" onclick="closeStateModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveStateEdits()">💾 Save Changes</button>
                <button class="btn btn-outline danger" onclick="deleteStateMilestone('${state}')">🗑️ Delete Milestone</button>
            `;
      }

      function generateCurrentStateActions(state) {
        return `
                <button class="btn btn-outline" onclick="closeStateModal()">Cancel</button>
                <button class="btn btn-warning" onclick="clearCurrentLocation()">📍 Clear Location</button>
                <button class="btn btn-success" onclick="recordQuickJump('${state}')">🎯 Record Jump</button>
            `;
      }

      function generatePendingStateActions(state) {
        return `
                <button class="btn btn-outline" onclick="closeStateModal()">Cancel</button>
                <button class="btn btn-outline" onclick="setAsCurrentLocation('${state}')">📍 Set as Current</button>
                <button class="btn btn-success" onclick="prefillMainForm('${state}')">📋 Use Main Form</button>
            `;
      }

      // State Management Action Functions
      function saveStateEdits() {
        if (!currentEditingState) return;

        const milestone = challengeData.milestones.find(
          (m) => m.state === currentEditingState
        );
        if (!milestone) return;

        // Update milestone data
        milestone.jumpTime = document.getElementById("editJumpDateTime").value;
        milestone.altitude =
          parseInt(document.getElementById("editAltitude").value) ||
          milestone.altitude;
        milestone.location =
          document.getElementById("editLocation").value || milestone.location;
        milestone.duration =
          parseInt(document.getElementById("editDuration").value) ||
          milestone.duration;
        milestone.weather =
          document.getElementById("editWeather").value || milestone.weather;
        milestone.notes =
          document.getElementById("editNotes").value || milestone.notes;

        saveData();
        updateAllDisplays();
        closeStateModal();
        showNotification(
          `✅ ${currentEditingState} information updated`,
          "success"
        );
      }

      function deleteStateMilestone(state) {
        const confirmation = prompt(
          `⚠️ WARNING: Delete milestone for ${state}?\n\n` +
            `This will permanently remove:\n` +
            `• All jump data for this state\n` +
            `• All uploaded videos\n` +
            `• State completion status\n\n` +
            `Type "DELETE" to confirm:`
        );

        if (confirmation === "DELETE") {
          // Remove from completed states
          challengeData.completedStates = challengeData.completedStates.filter(
            (s) => s !== state
          );

          // Remove milestone
          challengeData.milestones = challengeData.milestones.filter(
            (m) => m.state !== state
          );

          // Reorder completion numbers
          let order = 1;
          challengeData.milestones.forEach((m) => {
            if (!m.isSystem) {
              m.completionOrder = order++;
            }
          });

          saveData();
          updateAllDisplays();
          closeStateModal();
          showNotification(`🗑️ ${state} milestone deleted`, "success");

          // Add system milestone
          addSystemMilestone(
            `🗑️ Milestone for ${state} was deleted by administrator.`
          );
        }
      }

      function recordQuickJump(state) {
        const jumpDateTime = document.getElementById("quickJumpDateTime").value;
        const altitude = document.getElementById("quickAltitude").value;
        const location = document.getElementById("quickLocation").value;
        const duration = document.getElementById("quickDuration").value;
        const weather = document.getElementById("quickWeather").value;
        const notes = document.getElementById("quickNotes").value;

        if (!jumpDateTime || !altitude || !location) {
          showNotification(
            "⚠️ Please fill in required fields (Date/Time, Altitude, Location)",
            "error"
          );
          return;
        }

        // Create milestone
        const milestone = {
          id: generateUniqueId(),
          state: state,
          jumpTime: jumpDateTime,
          altitude: parseInt(altitude),
          location: location,
          duration: duration ? parseInt(duration) : null,
          weather: weather || "Not recorded",
          notes: notes || "",
          recordedAt: new Date().toISOString(),
          videos: [],
          completionOrder: challengeData.completedStates.length + 1,
        };

        // Update challenge data
        challengeData.milestones.unshift(milestone);
        challengeData.completedStates.push(state);

        // Clear current location
        challengeData.currentLocation = null;

        saveData();
        updateAllDisplays();
        closeStateModal();

        const completionMessage = `🎉 ${state} completed via quick recording! (${challengeData.completedStates.length}/50 states)`;
        addSystemMilestone(completionMessage);
        showNotification(completionMessage, "success");
      }

      function clearCurrentLocation() {
        challengeData.currentLocation = null;
        challengeData.locationTrackingEnabled = false;

        updateLocationToggle();
        saveData();
        updateAllDisplays();
        closeStateModal();
        showNotification("📍 Current location cleared", "success");
      }

      function setAsCurrentLocation(state) {
        challengeData.currentLocation = {
          state: state,
          city: "Downtown",
          status: "Preparing for jump",
          dropZone: `${state} Skydiving Center`,
          arrivalTime: new Date().toISOString(),
          estimatedJumpTime: new Date(
            Date.now() + 2 * 60 * 60 * 1000
          ).toISOString(),
          weather: {
            condition: "Clear skies",
            temperature: 72,
            windSpeed: 8,
            visibility: 10,
          },
        };

        challengeData.locationTrackingEnabled = true;

        updateLocationToggle();
        saveData();
        updateAllDisplays();
        closeStateModal();
        showNotification(`📍 Current location set to ${state}`, "success");
      }

      function prefillMainForm(state) {
        document.getElementById("stateSelect").value = state;
        document.getElementById("jumpDateTime").value = getCurrentDateTime();

        closeStateModal();

        // Scroll to milestone form
        document.getElementById("milestoneFormSection").scrollIntoView({
          behavior: "smooth",
          block: "start",
        });

        showNotification(`📋 Main form pre-filled with ${state}`, "success");
      }

      // Video Management Functions
      function triggerStateVideoInput() {
        document.getElementById("stateVideoFile").click();
      }

      function handleStateVideoSelection(input) {
        const files = Array.from(input.files);
        const milestone = challengeData.milestones.find(
          (m) => m.state === currentEditingState
        );

        if (!milestone) return;

        files.forEach((file) => {
          const fileSizeMB = file.size / (1024 * 1024);

          if (fileSizeMB > 500) {
            showNotification(
              `⚠️ ${file.name} is too large! Please select videos under 500MB.`,
              "error"
            );
            return;
          }

          if (!milestone.videos) {
            milestone.videos = [];
          }

          milestone.videos.push({
            fileName: file.name,
            originalName: file.name,
            size: file.size,
            type: file.type,
            uploadedAt: new Date().toISOString(),
          });
        });

        saveData();
        updateAllDisplays();

        // Refresh modal content
        const modalContent = document.getElementById("stateModalContent");
        modalContent.innerHTML = generateEditStateContent(milestone);

        showNotification(
          `📹 ${files.length} video(s) added to ${currentEditingState}`,
          "success"
        );
        input.value = "";
      }

      function removeStateVideo(videoIndex) {
        if (!currentEditingState) return;

        const milestone = challengeData.milestones.find(
          (m) => m.state === currentEditingState
        );
        if (!milestone || !milestone.videos) return;

        const video = milestone.videos[videoIndex];

        if (
          confirm(
            `Remove video "${video.originalName}" from ${currentEditingState}?`
          )
        ) {
          milestone.videos.splice(videoIndex, 1);

          saveData();
          updateAllDisplays();

          // Refresh modal content
          const modalContent = document.getElementById("stateModalContent");
          modalContent.innerHTML = generateEditStateContent(milestone);

          showNotification("🗑️ Video removed", "success");
        }
      }

      function playStateVideo(videoFileName) {
        showNotification(`🎬 Playing: ${videoFileName}`, "info");
        // In a real implementation, this would play the actual video file
      }

      // Data Management
      async function getc_data(cid) {
        console.log("Fetching challenge data for CID:", cid);

        const response = await fetch(`${API_BASE_URL}/admin/getchallengedata`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ cid }), // ✅ Wrap cid in an object
        });

        if (!response.ok) {
          console.error("Failed to fetch challenge data");
          return null;
        }

        const result = await response.json();
        if (response.ok && result["error"] == "Data not found") {
          console.error("Failed to fetch challenge data");
          return null;
        }
        challengeData = {
          ...challengeData, // keep existing frontend data
          ...result, // update top-level fields from backend
          completedStates: [
            ...challengeData.completedStates,
            ...(result.completedStates || []),
          ],
          milestones: [
            ...challengeData.milestones,
            ...(result.milestones || []),
          ],
          currentLocation:
            result.currentLocation || challengeData.currentLocation,
        };
        console.log("Challenge data received:", result);
        return true;
      }

      // Data Management
      async function loadChallengeData() {
        try {
          const cid = localStorage.getItem("challenge_id");
          console.log(cid);
          const response = await getc_data(cid); // ✅ await

          if (response) {
            console.log("The new challenge data is", challengeData);

            // Resume timer if active
            if (challengeData.isActive && challengeData.startTime) {
              startTimer();
            }

            // Update location tracking toggle
            updateLocationToggle();
            updateAllDisplays();

            console.log("✅ Challenge data loaded and UI updated");
          } else {
            console.warn("No challenge data found for this CID");
          }
        } catch (error) {
          console.error("Failed to load challenge data:", error);
          showNotification("⚠️ Failed to load data", "error");
        }
      }

      async function storec_data(challenge_id) {
        console.log("Saving the data");
        const response = await fetch(
          `${API_BASE_URL}/admin/savechallengedata`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json", // Tell FastAPI we're sending JSON
            },
            body: JSON.stringify({ challenge_id, challengeData }), // Convert JS object to JSON string
          }
        );
        if (response.ok) {
          return true;
        }
      }

      async function saveData() {
        try {
          challengeData.lastUpdate = new Date().toISOString();
          let challenge_id = localStorage.getItem("challenge_id");
          console.log(challengeData);
          console.log(challenge_id);

          let response = await storec_data(challenge_id);
          // localStorage.setItem(
          //   "skydiving50stateChallenge",
          //   JSON.stringify(challengeData)
          // );
          if (response == true) console.log("💾 Data saved successfully");
        } catch (error) {
          console.error("Failed to save data:", error);
          showNotification("❌ Failed to save data", "error");
        }
      }

      // Location Management
      function toggleLocationTracking() {
        const toggle = document.getElementById("locationToggle");
        const form = document.getElementById("locationForm");
        const updateBtn = document.getElementById("updateLocationBtn");

        challengeData.locationTrackingEnabled =
          !challengeData.locationTrackingEnabled;

        if (challengeData.locationTrackingEnabled) {
          console.log("In location enabled");
          toggle.classList.add("active");
          form.style.display = "grid";
          updateBtn.style.display = "block";

          // Pre-fill estimated jump time
          document.getElementById("estimatedJumpTime").value = new Date(
            Date.now() + 2 * 60 * 60 * 1000
          )
            .toISOString()
            .slice(0, 16);
        } else {
          toggle.classList.remove("active");
          form.style.display = "none";
          updateBtn.style.display = "none";
          challengeData.currentLocation = null;
        }

        saveData();
        updateAllDisplays();
      }

      function updateLocationToggle() {
        const toggle = document.getElementById("locationToggle");
        const form = document.getElementById("locationForm");
        const updateBtn = document.getElementById("updateLocationBtn");

        if (challengeData.locationTrackingEnabled) {
          toggle.classList.add("active");
          form.style.display = "grid";
          updateBtn.style.display = "block";

          // Populate form if location exists
          if (challengeData.currentLocation) {
            document.getElementById("currentState").value =
              challengeData.currentLocation.state || "";
            document.getElementById("currentCity").value =
              challengeData.currentLocation.city || "";
            document.getElementById("currentStatus").value =
              challengeData.currentLocation.status || "";
            document.getElementById("dropZone").value =
              challengeData.currentLocation.dropZone || "";
            document.getElementById("weatherCondition").value =
              challengeData.currentLocation.weather?.condition || "";
            document.getElementById("temperature").value =
              challengeData.currentLocation.weather?.temperature || "";
            document.getElementById("windSpeed").value =
              challengeData.currentLocation.weather?.windSpeed || "";

            if (challengeData.currentLocation.estimatedJumpTime) {
              document.getElementById("estimatedJumpTime").value = new Date(
                challengeData.currentLocation.estimatedJumpTime
              )
                .toISOString()
                .slice(0, 16);
            }
          }
        }
      }

      function updateCurrentLocation() {
        const state = document.getElementById("currentState").value;
        const city = document.getElementById("currentCity").value;
        const status = document.getElementById("currentStatus").value;
        const dropZone = document.getElementById("dropZone").value;
        const weatherCondition =
          document.getElementById("weatherCondition").value;
        const temperature = document.getElementById("temperature").value;
        const windSpeed = document.getElementById("windSpeed").value;
        const estimatedJumpTime =
          document.getElementById("estimatedJumpTime").value;

        if (!state || !city) {
          showNotification(
            "⚠️ Please fill in required fields (State and City)",
            "error"
          );
          return;
        }

        challengeData.currentLocation = {
          state,
          city,
          status,
          dropZone: dropZone || `${state} Skydiving Center`,
          arrivalTime:
            challengeData.currentLocation?.arrivalTime ||
            new Date().toISOString(),
          estimatedJumpTime: estimatedJumpTime
            ? new Date(estimatedJumpTime).toISOString()
            : new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
          weather: {
            condition: weatherCondition,
            temperature: parseInt(temperature) || 70,
            windSpeed: parseInt(windSpeed) || 8,
            visibility: 10,
          },
        };

        saveData();
        updateAllDisplays();
        showNotification(`📍 Location updated: ${city}, ${state}`, "success");
      }

      // Populate state selectors
      function populateStateSelectors() {
        const stateSelect = document.getElementById("stateSelect");
        const currentStateSelect = document.getElementById("currentState");

        stateSelect.innerHTML = '<option value="">Select state...</option>';
        currentStateSelect.innerHTML =
          '<option value="">Select current state...</option>';

        STATES.forEach((state) => {
          const option1 = document.createElement("option");
          option1.value = state;
          option1.textContent = state;
          stateSelect.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = state;
          option2.textContent = state;
          currentStateSelect.appendChild(option2);
        });
      }

      // Challenge Control
      async function setchallenge() {
        const response = await fetch(`${API_BASE_URL}/admin/challenge`, {
          method: "POST",
        });
        if (response.ok) {
          const data = await response.json();
          console.log("Challenge created:", data["id"]);
          localStorage.setItem("challenge_id", data["id"]);
        } else console.log("Cannot create the challenge id");
      }

      // Challenge Control
      async function startChallenge() {
        if (!challengeData.isActive) {
          challengeData.isActive = true;
          challengeData.startTime = new Date().toISOString();
          challengeData.pausedTime = null;
          await setchallenge();
          document.getElementById("startChallengeBtn").disabled = true;
          document.getElementById("pauseChallengeBtn").disabled = false;

          startTimer();
          saveData();
          updateAllDisplays();

          addSystemMilestone(
            "🚀 Challenge officially started! Timer is now running."
          );
          showNotification("🚀 Challenge started successfully!", "success");
        }
      }

      function pauseChallenge() {
        if (challengeData.isActive) {
          challengeData.isActive = false;
          challengeData.pausedTime = new Date().toISOString();

          document.getElementById("startChallengeBtn").disabled = false;
          document.getElementById("pauseChallengeBtn").disabled = true;

          stopTimer();
          saveData();
          updateAllDisplays();

          addSystemMilestone("⏸️ Challenge paused. Timer stopped.");
          showNotification("⏸️ Challenge paused", "warning");
        }
      }

      function resetChallenge() {
        const confirmReset = prompt(
          "⚠️ WARNING: This will permanently delete ALL challenge data!\n\n" +
            'Type "RESET" to confirm complete deletion:'
        );

        if (confirmReset === "RESET") {
          challengeData = {
            isActive: false,
            startTime: null,
            pausedTime: null,
            totalPausedDuration: 0,
            completedStates: [],
            milestones: [],
            lastUpdate: new Date().toISOString(),
            currentLocation: null,
            locationTrackingEnabled: false,
          };

          stopTimer();
          document.getElementById("startChallengeBtn").disabled = false;
          document.getElementById("pauseChallengeBtn").disabled = true;

          clearMilestoneForm();
          updateLocationToggle();
          saveData();
          updateAllDisplays();

          addSystemMilestone(
            "🔄 Challenge completely reset. Ready for new attempt!"
          );
          showNotification("🔄 Challenge reset successfully", "success");
        }
      }

      // Timer Functions
      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        const timerDisplay = document.getElementById("adminTimerDisplay");
        timerDisplay.classList.add("running");

        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        const timerDisplay = document.getElementById("adminTimerDisplay");
        timerDisplay.classList.remove("running");
      }

      function updateTimer() {
        if (!challengeData.startTime) {
          document.getElementById("adminTimerDisplay").textContent =
            "00:00:00:00";
          return;
        }

        const elapsed = calculateElapsedTime();
        const formatted = formatTimerDisplay(elapsed);
        document.getElementById("adminTimerDisplay").textContent = formatted;
      }

      function calculateElapsedTime() {
        if (!challengeData.startTime) return 0;

        const startTime = new Date(challengeData.startTime);
        const now = new Date();
        let elapsed = now - startTime;

        // Subtract paused duration
        elapsed -= challengeData.totalPausedDuration || 0;

        // If currently paused, subtract current pause duration
        if (challengeData.pausedTime && !challengeData.isActive) {
          const pausedTime = new Date(challengeData.pausedTime);
          elapsed -= now - pausedTime;
        }

        return Math.max(0, elapsed);
      }

      function formatTimerDisplay(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const days = Math.floor(totalSeconds / (24 * 3600));
        const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        return `${days.toString().padStart(2, "0")}:${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
          .toString()
          .padStart(2, "0")}`;
      }

      // Milestone Management
      function validateStateSelection() {
        const selectedState = document.getElementById("stateSelect").value;
        if (
          selectedState &&
          challengeData.completedStates.includes(selectedState)
        ) {
          showNotification(
            `⚠️ ${selectedState} has already been completed!`,
            "warning"
          );
          document.getElementById("stateSelect").value = "";
        }
      }

      function saveMilestone() {
        // Validate required fields
        const state = document.getElementById("stateSelect").value;
        const jumpDateTime = document.getElementById("jumpDateTime").value;
        const altitude = document.getElementById("altitude").value;
        const location = document.getElementById("location").value;

        if (!state || !jumpDateTime || !altitude || !location) {
          showNotification("⚠️ Please fill in all required fields", "error");
          return;
        }

        if (challengeData.completedStates.includes(state)) {
          showNotification(`❌ ${state} has already been completed!`, "error");
          return;
        }

        // Validate altitude
        const altitudeNum = parseInt(altitude);
        if (altitudeNum < 1000 || altitudeNum > 50000) {
          showNotification(
            "⚠️ Altitude must be between 1,000 and 50,000 feet",
            "error"
          );
          return;
        }

        // Validate jump time
        const jumpTime = new Date(jumpDateTime);
        if (jumpTime > new Date()) {
          showNotification("⚠️ Jump time cannot be in the future", "error");
          return;
        }

        // Create milestone record with video information
        const milestone = {
          id: generateUniqueId(),
          state: state,
          jumpTime: jumpDateTime,
          altitude: altitudeNum,
          location: location,
          duration: document.getElementById("duration").value
            ? parseInt(document.getElementById("duration").value)
            : null,
          weather: document.getElementById("weather").value || "Not recorded",
          notes: document.getElementById("notes").value || "",
          recordedAt: new Date().toISOString(),
          videos: uploadedVideoFiles.map((video) => ({
            fileName: video.name,
            originalName: video.name,
            size: video.size,
            type: video.type,
            uploadedAt: new Date().toISOString(),
          })),
          completionOrder: challengeData.completedStates.length + 1,
        };

        // Update challenge data
        challengeData.milestones.unshift(milestone);
        challengeData.completedStates.push(state);

        // If this state was current location, clear it
        if (challengeData.currentLocation?.state === state) {
          challengeData.currentLocation = null;
        }

        // Clear form and save
        clearMilestoneForm();
        saveData();
        updateAllDisplays();

        // Success feedback
        const completionMessage = `🎉 ${state} completed! (${challengeData.completedStates.length}/50 states)`;
        addSystemMilestone(completionMessage);
        showNotification(completionMessage, "success");

        // Check for completion
        if (challengeData.completedStates.length === 50) {
          handleChallengeCompletion();
        }
      }

      function handleChallengeCompletion() {
        challengeData.isActive = false;
        challengeData.completionTime = new Date().toISOString();
        stopTimer();

        const totalTime = formatTimerDisplay(calculateElapsedTime());
        addSystemMilestone(
          `🏆 WORLD RECORD ATTEMPT COMPLETED! All 50 states in ${totalTime}!`
        );
        showNotification(
          "🏆 CONGRATULATIONS! 50-state challenge completed!",
          "success"
        );

        setTimeout(() => {
          alert(
            `🏆 WORLD RECORD ACHIEVEMENT!\n\nAll 50 states completed in: ${totalTime}\n\nCongratulations on this incredible accomplishment!`
          );
        }, 1000);
      }

      function clearMilestoneForm() {
        document.getElementById("stateSelect").value = "";
        document.getElementById("jumpDateTime").value = getCurrentDateTime();
        document.getElementById("altitude").value = "";
        document.getElementById("location").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("weather").value = "";
        document.getElementById("notes").value = "";
        document.getElementById("videoFile").value = "";
        document.getElementById("fileUpload").classList.remove("has-file");

        // Clear uploaded videos
        uploadedVideoFiles = [];
        updateUploadedVideosDisplay();
      }

      function addSystemMilestone(message) {
        const milestone = {
          id: generateUniqueId(),
          message: message,
          timestamp: new Date().toISOString(),
          isSystem: true,
        };

        challengeData.milestones.unshift(milestone);
        saveData();
      }

      // File Handling
      function triggerFileInput() {
        document.getElementById("videoFile").click();
      }

      function handleFileSelection(input) {
        const files = Array.from(input.files);

        files.forEach((file) => {
          const fileSizeMB = file.size / (1024 * 1024);

          if (fileSizeMB > 500) {
            showNotification(
              `⚠️ ${file.name} is too large! Please select videos under 500MB.`,
              "error"
            );
            return;
          }

          if (
            !uploadedVideoFiles.find(
              (existing) =>
                existing.name === file.name && existing.size === file.size
            )
          ) {
            uploadedVideoFiles.push(file);
          }
        });

        updateUploadedVideosDisplay();
        input.value = "";
      }

      function updateUploadedVideosDisplay() {
        const container = document.getElementById("uploadedVideos");
        const uploadArea = document.getElementById("fileUpload");

        if (uploadedVideoFiles.length > 0) {
          uploadArea.classList.add("has-file");
          container.innerHTML = uploadedVideoFiles
            .map(
              (file, index) => `
                    <div class="uploaded-video-item">
                        <div class="video-thumbnail">🎬</div>
                        <div class="video-details">
                            <div class="video-name">${file.name}</div>
                            <div class="video-size">${(
                              file.size /
                              (1024 * 1024)
                            ).toFixed(2)} MB</div>
                        </div>
                        <button class="video-remove" onclick="removeVideo(${index})">Remove</button>
                    </div>
                `
            )
            .join("");
        } else {
          uploadArea.classList.remove("has-file");
          container.innerHTML = "";
        }
      }

      function removeVideo(index) {
        uploadedVideoFiles.splice(index, 1);
        updateUploadedVideosDisplay();
        showNotification("Video removed", "success");
      }

      // Display Updates
      function updateAllDisplays() {
        updateDashboardStats();
        updateStatesOverview();
        updateDataManagement();
      }

      function updateDashboardStats() {
        const completed = challengeData.completedStates.length;
        const elapsed = calculateElapsedTime();

        document.getElementById("dashCompletedStates").textContent = completed;
        document.getElementById("dashTotalTime").textContent =
          formatDuration(elapsed);

        // Count total videos
        const videoCount = challengeData.milestones.reduce(
          (total, milestone) => {
            return total + (milestone.videos ? milestone.videos.length : 0);
          },
          0
        );
        document.getElementById("dashVideoCount").textContent = videoCount;

        // Status
        let status = "Not Started";
        if (challengeData.isActive) {
          status = "Active";
        } else if (completed === 50) {
          status = "Completed";
        } else if (completed > 0) {
          status = "Paused";
        }
        document.getElementById("dashStatus").textContent = status;

        // Best day calculation
        const bestDay = calculateBestDay();
        document.getElementById("dashBestDay").textContent = bestDay;
      }

      function calculateBestDay() {
        const milestones = challengeData.milestones.filter((m) => !m.isSystem);
        const dayGroups = {};

        milestones.forEach((milestone) => {
          const date = new Date(milestone.jumpTime).toDateString();
          dayGroups[date] = (dayGroups[date] || 0) + 1;
        });

        return Math.max(0, ...Object.values(dayGroups));
      }

      function updateStatesOverview() {
        const grid = document.getElementById("adminStatesGrid");
        const completed = challengeData.completedStates.length;
        const currentState = challengeData.currentLocation?.state;

        document.getElementById("statesCompleted").textContent = completed;

        grid.innerHTML = "";

        STATES.forEach((state) => {
          const item = document.createElement("div");
          item.className = "state-item";
          item.textContent = state;

          if (challengeData.completedStates.includes(state)) {
            item.classList.add("completed");
          } else if (
            currentState === state &&
            challengeData.locationTrackingEnabled
          ) {
            item.classList.add("current-location");
          }

          // Add click handler for state management
          item.addEventListener("click", () => openStateModal(state));

          grid.appendChild(item);
        });
      }

      function updateDataManagement() {
        console.log("Data management challenge data", challengeData);
        document.getElementById("totalMilestones").textContent =
          challengeData.milestones.length;

        const dataSize = new Blob([JSON.stringify(challengeData)]).size;
        document.getElementById("dataSize").textContent =
          (dataSize / 1024).toFixed(1) + " KB";

        if (challengeData.lastUpdate) {
          const lastUpdate = new Date(challengeData.lastUpdate);
          document.getElementById("lastUpdate").textContent =
            formatTime(lastUpdate);
        }
      }

      // Data Management Functions
      function exportData() {
        try {
          const dataStr = JSON.stringify(challengeData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);

          const link = document.createElement("a");
          link.href = url;
          link.download = `skydiving-challenge-backup-${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          link.click();

          URL.revokeObjectURL(url);
          showNotification("📤 Data exported successfully", "success");
        } catch (error) {
          showNotification("❌ Failed to export data", "error");
        }
      }

      function importData() {
        document.getElementById("importFile").click();
      }

      function handleDataImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);

            if (confirm("⚠️ This will replace all current data. Continue?")) {
              challengeData = { ...challengeData, ...importedData };
              saveData();
              updateAllDisplays();
              updateLocationToggle();
              showNotification("📥 Data imported successfully", "success");
            }
          } catch (error) {
            showNotification("❌ Invalid file format", "error");
          }
        };
        reader.readAsText(file);
      }

      function clearAllData() {
        const confirmation = prompt(
          '⚠️ Type "DELETE ALL" to confirm complete data deletion:'
        );
        if (confirmation === "DELETE ALL") {
          challengeData = {
            isActive: false,
            startTime: null,
            pausedTime: null,
            totalPausedDuration: 0,
            completedStates: [],
            milestones: [],
            lastUpdate: new Date().toISOString(),
            currentLocation: null,
            locationTrackingEnabled: false,
          };

          stopTimer();
          updateLocationToggle();
          saveData();
          updateAllDisplays();
          showNotification("🗑️ All data cleared", "success");
        }
      }

      function backupData() {
        exportData();
      }

      function refreshData() {
        loadChallengeData();
        updateAllDisplays();
        showNotification("🔄 Data refreshed", "success");
      }

      // Utility Functions
      function generateUniqueId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function formatDuration(milliseconds) {
        const hours = Math.floor(milliseconds / (1000 * 60 * 60));
        const minutes = Math.floor(
          (milliseconds % (1000 * 60 * 60)) / (1000 * 60)
        );

        if (hours > 0) {
          return `${hours}h ${minutes}m`;
        } else if (minutes > 0) {
          return `${minutes}m`;
        } else {
          return "<1m";
        }
      }

      function formatTime(date) {
        return date.toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatDateTime(date) {
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatDate(date) {
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
        });
      }

      function formatFileSize(bytes) {
        if (!bytes) return "Unknown size";
        const mb = bytes / (1024 * 1024);
        return mb.toFixed(1) + " MB";
      }

      // Notifications
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = "notification";
        notification.innerHTML = `<strong>${message}</strong>`;

        if (type === "error" || type === "warning") {
          notification.style.background =
            type === "error" ? "var(--danger)" : "var(--warning)";
        } else if (type === "info") {
          notification.style.background = "var(--primary)";
        }

        document.body.appendChild(notification);

        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 3000);
      }

      // Real-time Updates
      function startRealTimeUpdates() {
        setInterval(() => {
          if (challengeData.isActive) {
            updateTimer();
            updateDashboardStats();
          }
        }, 1000);
      }

      // Close modal when clicking outside
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-overlay")) {
          closeStateModal();
        }
      });

      // Close modal with escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeStateModal();
        }
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("🛡️ SkyRecord Admin Panel Ready");
      });
    </script>
  </body>
</html>
